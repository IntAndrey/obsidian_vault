Общиймодуль.ДенежныеСредстваКлиент.Модуль
Иначе
		Если ИдентификаторУстройства <> Неопределено Тогда
			ПараметрыВыполнения.Вставить("ОповещениеПриЗавершении", ОповещениеПриЗавершении);
			//Исправление ошибки с отсутвием поля Организация и Кассир ОбщийМодуль.ШаблоныФискальныхДокументовСлужебный.Модуль(629)}: Поле объекта не обнаружено (Организация)"
			//ПараметрыОперации = Новый Структура("ТипИнкассации, Сумма", 0, ПараметрыВыполнения.ИзымаемаяСумма);
			Пользователь = ПользователиКлиентСервер.ТекущийПользователь();
Стр. 185

ОбщийМодуль.ОборудованиеЧекопечатающиеУстройства.Модуль
Стр. 3287
Функция ПодготовитьДанныеОперации(ПараметрыПодключения, Команда, ПараметрыОперации) Экспорт
	
	ШиринаСтроки = ?(ПараметрыПодключения.Свойство("ШиринаСтроки") И ПараметрыПодключения.ШиринаСтроки > 0, ПараметрыПодключения.ШиринаСтроки, 32);
	
	ДанныеОперации = Новый Структура();
	ДанныеОперации.Вставить("Результат", Истина);
	ДанныеОперации.Вставить("ТекстОшибки");
	ДанныеОперации.Вставить("ТестовыеЧеки");
	ДанныеОперации.Вставить("ТекстЧека");
	
	// Для всех операций проверяем корректность ИНН кассира.
	Если ПараметрыОперации <> Неопределено И ПараметрыОперации.Свойство("КассирИНН") И НЕ ПустаяСтрока(ПараметрыОперации.КассирИНН) Тогда
		ОписаниеОшибки = "";
		Если НЕ ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ИННСоответствуетТребованиям(ПараметрыОперации.КассирИНН, Ложь, ОписаниеОшибки) Тогда
			ТекстОшибки = НСтр("ru = 'ИНН кассира некорректен (%Ошибка%)'");
			ОписаниеОшибки = СтрЗаменить(ТекстОшибки, "%Ошибка%", ОписаниеОшибки);
			ДанныеОперации.Результат = Ложь;
			ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
			Возврат ДанныеОперации;
		КонецЕсли;
	КонецЕсли;
	
	// Для всех операций проверяем корректность ИНН организации.
	Если  ПараметрыОперации <> Неопределено И ПараметрыОперации.Свойство("ОрганизацияИНН") И НЕ ПустаяСтрока(ПараметрыОперации.ОрганизацияИНН) Тогда
		Если СтрДлина(ПараметрыОперации.ОрганизацияИНН) <> 10 И СтрДлина(ПараметрыОперации.ОрганизацияИНН) <> 12 Тогда
			ОписаниеОшибки = НСтр("ru = 'Неверная длина ИНН организации.'");
			ДанныеОперации.Результат = Ложь;
			ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
			Возврат ДанныеОперации;
		КонецЕсли;
	КонецЕсли;
	
	// Для всех операций проверяем корректность длины поля Кассир (ФФД 1021) (макс 64)
	Если  ПараметрыОперации <> Неопределено И ПараметрыОперации.Свойство("Кассир") И НЕ ПустаяСтрока(ПараметрыОперации.Кассир) Тогда
		Если СтрДлина(ПараметрыОперации.Кассир) > 64 Тогда
			ПараметрыОперации.Кассир = Лев(СокрЛП(ПараметрыОперации.Кассир),64);
		КонецЕсли;
	КонецЕсли;
	
	Если Команда = "CheckFiscalization" Тогда
		 //Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
			
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
			
		//КонецЕсли;
		
		СтатусПоследнейСмены = ПолучитьСтатусПоследнейСмены(ПараметрыПодключения.ИдентификаторУстройства);
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			
			Если Не СтатусПоследнейСмены.Активна = Истина Тогда
				ОписаниеОшибки = НСтр("ru='Кассовая смена не открыта или истекла.'");
				ДанныеОперации.Результат = Ложь;
				ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
				Возврат ДанныеОперации;
			Иначе
				// Форматно логический контроль
				ОписаниеОшибки = "";
				Если ОбщегоНазначенияБПО.ИспользуетсяФорматноЛогическийКонтроль() Тогда
					МодульФорматноЛогическийКонтроль = ОбщегоНазначенияБПО.ОбщийМодуль("ФорматноЛогическийКонтроль");
					Если НЕ МодульФорматноЛогическийКонтроль.ВыполненаПроверкаОбязательностиИПравильностиЗаполненияТэгов(
						ПараметрыОперации, 
						ПараметрыПодключения.ИдентификаторУстройства, 
						ОписаниеОшибки) Тогда
						ДанныеОперации.Результат = Ложь;
						ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
						Возврат ДанныеОперации;
					КонецЕсли;
					МодульФорматноЛогическийКонтроль.ПривестиДанныеКТребуемомуФормату(ПараметрыОперации);
				КонецЕсли;
			КонецЕсли;
			
		КонецЕсли;
		
		// Параметры фискализации чека
		ПараметрыФискализации = ПараметрыФискализацииЧека();
		ПараметрыФискализации.ТекущаяСмена = СтатусПоследнейСмены.КассоваяСмена;
		
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			
			// Параметры регистрации ККТ
			ПараметрыРегистрации = ПараметрыРегистрацииУстройства(ПараметрыПодключения.ИдентификаторУстройства);
			ВерсияФФДККТ11 = ?(ПараметрыРегистрации.Свойство("ВерсияФФДККТ"), ПараметрыРегистрации.ВерсияФФДККТ, "1.05");
			ВерсияФФДККТ11 = ВерсияФФДККТ11 = "1.1" Или  ВерсияФФДККТ11 = "1.2"; // Признак ФФД 1.1
			
			ПараметрыОперации = ШаблонЧека(ПараметрыОперации, Перечисления.ТипыПодключаемогоОборудования.ККТ, Неопределено, ПараметрыПодключения.ИдентификаторУстройства);
			
			// добавить текст короткого слип чека в тело фискального чека
			Если Не ПустаяСтрока(ПараметрыОперации.ТекстКороткогоСлипЧека) Тогда
				СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека(ПараметрыОперации.ТекстКороткогоСлипЧека);
				СтрокаЧека.Выравнивание = "Центр";
				ПараметрыОперации.ПозицииЧека.Добавить(СтрокаЧека);
			КонецЕсли;
			
			ПараметрыФискализации.РегистрационныйНомерККТ = ?(ПараметрыРегистрации.Свойство("РегистрационныйНомерККТ"), ПараметрыРегистрации.РегистрационныйНомерККТ, "");
			ПараметрыФискализации.ЗаводскойНомерФН  = ?(ПараметрыРегистрации.Свойство("ЗаводскойНомерФН"), ПараметрыРегистрации.ЗаводскойНомерФН, "");
			ПараметрыФискализации.ШиринаСтроки      = ШиринаСтроки;
			ПараметрыФискализации.РевизияИнтерфейса = ПараметрыПодключения.РевизияИнтерфейса;
			ПараметрыФискализации.ДокументОснование = ПараметрыОперации.ДокументОснование;
			ПараметрыФискализации.ИдентификаторФискальнойЗаписи = ПараметрыОперации.ИдентификаторФискальнойЗаписи;
			ПараметрыФискализации.Организация       = ПараметрыОперации.Организация;
			ПараметрыФискализации.ТорговыйОбъект    = ПараметрыОперации.ТорговыйОбъект;
			ПараметрыФискализации.ДополнительныйРеквизит = ПараметрыОперации.ДополнительныйРеквизит;  
			ПараметрыФискализации.СубъектПерсональныхДанных = ПараметрыОперации.СубъектПерсональныхДанных;
			ПараметрыФискализации.ЕстьПерсональныеДанные    = ПараметрыОперации.ЕстьПерсональныеДанные;
			Если ПараметрыОперации.Свойство("ИдентификаторОплатыПлатежнойСистемы") Тогда 
				ПараметрыФискализации.ИдентификаторОплатыПлатежнойСистемы = ПараметрыОперации.ИдентификаторОплатыПлатежнойСистемы;
			КонецЕсли;
			Если ПараметрыОперации.Свойство("ТипПлатежнойСистемы") Тогда 
				ПараметрыФискализации.ТипПлатежнойСистемы = ПараметрыОперации.ТипПлатежнойСистемы;
			КонецЕсли;
			Если ПараметрыОперации.Свойство("КорректируемыйДокумент") Тогда 
				ПараметрыФискализации.КорректируемыйДокумент = ПараметрыОперации.КорректируемыйДокумент;
			КонецЕсли;
			ПараметрыФискализации.Кассир       = ПараметрыОперации.Кассир;
			ПараметрыФискализации.КассирИНН    = ПараметрыОперации.КассирИНН;
			ПараметрыФискализации.Электронно   = ПараметрыОперации.Электронно;
			ПараметрыФискализации.Отправляет1СSMS   = ПараметрыОперации.Отправляет1СSMS;
			Если ПараметрыОперации.Отправляет1СSMS Тогда
				ПараметрыФискализации.ПокупательНомер = ПараметрыОперации.ПокупательНомер;
			КонецЕсли;
			ПараметрыФискализации.Отправляет1СEmail = ПараметрыОперации.Отправляет1СEmail;
			Если ПараметрыОперации.Отправляет1СEmail Тогда
				ПараметрыФискализации.ПокупательEmail = ПараметрыОперации.ПокупательEmail;
			КонецЕсли;
			ПараметрыФискализации.ВерсияФФДККТ11    = ВерсияФФДККТ11;
			ПараметрыФискализации.ЕдиныйЧек         = ПараметрыОперации.ЕдиныйЧек;
			ПараметрыФискализации.ТипДокумента = Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧек;
			СформироватьXMLПакетДляФискализацияЧека(ПараметрыОперации, ПараметрыФискализации);
			
			Если ПараметрыФискализации.ЕстьПерсональныеДанные Тогда
				Если ПустаяСтрока(ПараметрыФискализации.ДатаВремяЧека) Тогда
					ДатаВремяЧека = ОбщегоНазначенияБПО.ДатаСеанса();
				Иначе
					ДатаВремяЧека = ПараметрыФискализации.ДатаВремяЧека;
				КонецЕсли;
				СведенияОПокупателе = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыПерсональныеДанныеПокупателя();
				ПараметрыФискализации.ТипПерсональныхДанных = ПараметрыОперации.ТипПерсональныхДанных;
				МенеджерОборудованияВызовСервераПереопределяемый.ОбработкаЗаполненияПерсональныхДанных(СведенияОПокупателе, ПараметрыФискализации.СубъектПерсональныхДанных, 
					ПараметрыФискализации.ТипПерсональныхДанных, ДатаВремяЧека);
				СформироватьXMLПакетДляФискализацияЧека(ПараметрыОперации, ПараметрыФискализации, Истина, СведенияОПокупателе, ПараметрыФискализации.ТипПерсональныхДанных);
			КонецЕсли;
			
			ПараметрыФискализации.ТекущееСостояние.ПараметрыXML = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
			
		ИначеЕсли ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			ПараметрыОперации.НомерЧека = СтатусПоследнейСмены.ТекущийНомерЧека;      
			ПараметрыФискализации.НомерЧекаККТ = ПараметрыОперации.НомерЧека;
			ПараметрыОперации = ШаблонЧека(ПараметрыОперации, Перечисления.ТипыПодключаемогоОборудования.ПринтерЧеков, Неопределено, ПараметрыПодключения.ИдентификаторУстройства);
			
			// добавить текст короткого слип чека в тело фискального чека
			Если Не ПустаяСтрока(ПараметрыОперации.ТекстКороткогоСлипЧека) Тогда
				СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека(ПараметрыОперации.ТекстКороткогоСлипЧека);
				СтрокаЧека.Выравнивание = "Центр";
				ПараметрыОперации.ПозицииЧека.Добавить(СтрокаЧека);
			КонецЕсли;
			
			Шаблон = ШаблоныФискальныхДокументов.ШаблонКассовыйЧек(ШиринаСтроки, ПараметрыОперации);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон);
			ПараметрыФискализации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
			ПараметрыФискализации.ТекстЧека = ТекстЧека; 
			
		КонецЕсли;
		
		Если ЗначениеЗаполнено(ПараметрыОперации.УстройствоПечати) И НЕ ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			Шаблон = ШаблоныФискальныхДокументов.ШаблонКассовыйЧек(ШиринаСтроки, ПараметрыОперации);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон);
			ПараметрыФискализации.КопияЧека = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
			ПараметрыФискализации.ТекстЧека = ТекстЧека;
			
		КонецЕсли;
		
		Если ПараметрыОперации.ПакетДокументов <> Неопределено И ПараметрыОперации.ПакетДокументов.Количество() > 0 Тогда
			
			Если ПараметрыФискализации.ДополнительныеДокументы = Неопределено Тогда
				ПараметрыФискализации.ДополнительныеДокументы = Новый Массив();
			КонецЕсли;
			
			Для Каждого ДополнительныйДокумент ИЗ ПараметрыОперации.ПакетДокументов Цикл
				ТекстПечати = ПолучитьXMLПакетДляТекста(ДополнительныйДокумент.Ключ, ПараметрыПодключения.РевизияИнтерфейса);
				ПараметрыФискализации.ДополнительныеДокументы.Добавить(Новый Структура("ТекстПечати, УстройствоПечати" , ТекстПечати, ДополнительныйДокумент.Значение));
			КонецЦикла;
			
		КонецЕсли;
		
		Если ПараметрыОперации.НефискальныеДокументы <> Неопределено И ПараметрыОперации.НефискальныеДокументы.Количество() > 0 Тогда
			Если ПараметрыФискализации.ТестовыеЧеки = Неопределено Тогда
				ПараметрыФискализации.ТестовыеЧеки = Новый Массив();
			КонецЕсли;
				ЗаполнитьXMLПакетыДляТекстовогоДокумента(
				ПараметрыФискализации.ТестовыеЧеки, 
				ПараметрыОперации.НефискальныеДокументы, 
				ПараметрыПодключения, 
				ШиринаСтроки);
		КонецЕсли;
		
		Возврат ПараметрыФискализации;
			
	ИначеЕсли Команда = "PrintReceiptCorrection" Тогда
		//Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
		//	
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
		//	
		//КонецЕсли;
		
		ПараметрыФискализации = ПараметрыФискализацииЧека();              
		// Параметры регистрации ККТ
		ПараметрыРегистрации = ПараметрыРегистрацииУстройства(ПараметрыПодключения.ИдентификаторУстройства); 
		ВерсияФФДККТ11 = ?(ПараметрыРегистрации.Свойство("ВерсияФФДККТ"), ПараметрыРегистрации.ВерсияФФДККТ, "1.05");
		ВерсияФФДККТ11 = ВерсияФФДККТ11 = "1.1" Или ВерсияФФДККТ11 = "1.2"; // Признак ФФД 1.1
		
		Если (ПараметрыПодключения.РевизияИнтерфейса < 3000 И ПараметрыОперации.НеприменениеККТ) 
			И (ПараметрыОперации.ТипРасчета = Перечисления.ТипыРасчетаДенежнымиСредствами.ВозвратДенежныхСредств 
			Или ПараметрыОперации.ТипРасчета = Перечисления.ТипыРасчетаДенежнымиСредствами.ВозвратРасходаДенежныхСредств) Тогда
			ПараметрыФискализации.Результат = Ложь;
			ПараметрыФискализации.ТекстОшибки = НСтр("ru='Для данного типа расчета нельзя сформировать чек коррекции для данного ККТ.'");
			Возврат ПараметрыФискализации;
		КонецЕсли;    
		
		// Параметры фискализации чека
		ПараметрыФискализации.НеприменениеККТ   = ПараметрыОперации.НеприменениеККТ;
		ПараметрыФискализации.Кассир            = ПараметрыОперации.Кассир;
		ПараметрыФискализации.Электронно        = ПараметрыОперации.Электронно;
		ПараметрыФискализации.Отправляет1СSMS   = ПараметрыОперации.Отправляет1СSMS;
		ПараметрыФискализации.Отправляет1СEmail = ПараметрыОперации.Отправляет1СEmail;
		ПараметрыФискализации.Организация       = ПараметрыОперации.Организация;
		ПараметрыФискализации.ТорговыйОбъект    = ПараметрыОперации.ТорговыйОбъект;
		ПараметрыФискализации.ДополнительныйРеквизит = ПараметрыОперации.ДополнительныйРеквизит;  
		ПараметрыФискализации.ВерсияФФДККТ11    = ВерсияФФДККТ11; 
		ПараметрыФискализации.ЕдиныйЧек         = ПараметрыОперации.ЕдиныйЧек;
		ПараметрыФискализации.РегистрационныйНомерККТ = ?(ПараметрыРегистрации.Свойство("РегистрационныйНомерККТ"), ПараметрыРегистрации.РегистрационныйНомерККТ, "");
		ПараметрыФискализации.ЗаводскойНомерФН  = ?(ПараметрыРегистрации.Свойство("ЗаводскойНомерФН"), ПараметрыРегистрации.ЗаводскойНомерФН, "");
		ПараметрыФискализации.ШиринаСтроки      = ШиринаСтроки;
		ПараметрыФискализации.РевизияИнтерфейса = ПараметрыПодключения.РевизияИнтерфейса;
		ПараметрыФискализации.ДокументОснование = ПараметрыОперации.ДокументОснование;
		ПараметрыФискализации.ИдентификаторФискальнойЗаписи  = ПараметрыОперации.ИдентификаторФискальнойЗаписи;    
		ПараметрыФискализации.СформироватьЧекКоррекцииСторно = ПараметрыОперации.СформироватьЧекКоррекцииСторно;
		Если ПараметрыОперации.Свойство("КорректируемыйДокумент") Тогда 
			ПараметрыФискализации.КорректируемыйДокумент = ПараметрыОперации.КорректируемыйДокумент;
		КонецЕсли;
		
		Если ПараметрыОперации.НеприменениеККТ Тогда    
			ПараметрыФискализации.СформироватьЧекКоррекцииСторно = Ложь;   
		КонецЕсли; 
		
		Если НЕ ПараметрыФискализации.СформироватьЧекКоррекцииСторно Тогда 
			// Сценарий 1 - неприменение ККТ. 
			Если ПараметрыОперации.НеприменениеККТ И ЗначениеЗаполнено(ПараметрыОперации.КорректируемыйДокумент) Тогда
				ПараметрыФискализации.Результат = Ложь;
				ПараметрыФискализации.ТекстОшибки = НСтр("ru='Чек коррекции «неприменение ККТ» нельзя сформировать для фискализированного ранее чека.'");
				Возврат ПараметрыФискализации;
			КонецЕсли;                        
			
			ПараметрыФискализации.ЧекКоррекцииНаККТ = Истина;   
			Если НЕ ПараметрыФискализации.НеприменениеККТ И НЕ ПараметрыФискализации.СформироватьЧекКоррекцииСторно И НЕ ВерсияФФДККТ11 Тогда
				ПараметрыФискализации.ЧекКоррекцииНаККТ = Ложь;
				// НеприменениеККТ не используется, СформироватьЧекКоррекцииСторно содержит Ложь
				// ВерсияФФДККТ11 содержит Ложь, ФФД меньше 1.1
				ЗаменитьТипыОплатыПриКоррекции(ПараметрыОперации, Неопределено);
			КонецЕсли;                                                                                   
			ПараметрыФискализации.ТипДокумента = ?(ПараметрыФискализации.ЧекКоррекцииНаККТ, Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧекКоррекции, Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧек);
			СформироватьXMLПакетДляЧекаКоррекции(ПараметрыОперации, ПараметрыФискализации);
		Иначе
			// Сценарий 2 - исправление нарушений применения ККТ.
			Если ПустаяСтрока(ПараметрыОперации.КорректируемыйДокумент) Тогда
				ПараметрыФискализации.Результат = Ложь; 
				ПараметрыФискализации.ТекстОшибки = НСтр("ru='Корректируемый документ не указан для формирования чека коррекции.'");
				Возврат ПараметрыФискализации;
			КонецЕсли;       
			
			ТипыДокументов = Новый Массив();
			ТипыДокументов.Добавить(Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧек); // Для ФФД 1.05
			ТипыДокументов.Добавить(Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧекКоррекции); // Для ФФД 1.1
			
			КорректируемыйДокументОперация = ДанныеФискальнойОперации(ПараметрыОперации.КорректируемыйДокумент, ,ТипыДокументов); 
			Если КорректируемыйДокументОперация = Неопределено Тогда
				ПараметрыФискализации.Результат = Ложь; 
				ПараметрыФискализации.ТекстОшибки = НСтр("ru='Не найден ранее фискализированный кассовый чек для формирования чека коррекции.'");
				Возврат ПараметрыФискализации;
			КонецЕсли;            
			
			// В зависимости от версии ФФД формируем "Кассовый чек" или "Кассовый чек коррекции".   
			ПараметрыФискализации.ЧекКоррекцииНаККТ = ВерсияФФДККТ11;
			ТипФискальногоДокументов = ?(ПараметрыФискализации.ЧекКоррекцииНаККТ, Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧекКоррекции, Перечисления.ТипыФискальныхДокументовККТ.КассовыйЧек);
			// Дополнительный реквизит чека - фискальным признаком документа основания (по которому идет коррекция).
			ФискальныйПризнак = КорректируемыйДокументОперация.ФискальныйПризнак;
			
			// Формируем кассовый чек с корректными реквизитами.
			ПараметрыОперации.ДополнительныйРеквизит = ФискальныйПризнак;
			ПараметрыФискализации.ДополнительныйРеквизит = ФискальныйПризнак;  
			ПараметрыФискализации.ТипДокумента = ТипФискальногоДокументов;
			
			// Формируем параметры фискализации для сторнирующего чека коррекции.
			ДанныеСторноЧекаXML = КорректируемыйДокументОперация.ДанныеXML.Получить();
			ОбщиеПараметрыСторно = ЗагрузитьДанныеФискализацииИзXML(ДанныеСторноЧекаXML);
			ОбщиеПараметрыСторно.ДополнительныйРеквизит = ФискальныйПризнак;
			
			ЗаполнитьЗначенияСвойств(ОбщиеПараметрыСторно.ДанныеКоррекции, ПараметрыОперации.ДанныеКоррекции);
			ПодготовитьЧекКоррекции(ПараметрыОперации, ОбщиеПараметрыСторно, ВерсияФФДККТ11);
			// Для формата 1.05
			Если НЕ ВерсияФФДККТ11 Тогда            
				ЗаменитьТипыОплатыПриКоррекции(ПараметрыОперации, ОбщиеПараметрыСторно);
			КонецЕсли;  
			
			СформироватьXMLПакетДляФискализацияЧека(ПараметрыОперации, ПараметрыФискализации);
			
			ПараметрыФискализацииСторно = ПараметрыФискализацииЧека();
			ЗаполнитьЗначенияСвойств(ПараметрыФискализацииСторно, ПараметрыФискализации);
			СформироватьXMLПакетДляФискализацияЧека(ОбщиеПараметрыСторно, ПараметрыФискализацииСторно);
			
			ПараметрыФискализации.ЧекКоррекцииСторно = ПараметрыФискализацииСторно;
			
		КонецЕсли;
	
		Возврат ПараметрыФискализации;
		
	ИначеЕсли Команда = "PrintCheckCopy" Тогда            
		
		Аппаратно = ?(ПараметрыОперации.Свойство("Аппаратно"), ПараметрыОперации.Аппаратно, Истина);
		
		Если Не Аппаратно Тогда 
			ДокументСсылка = ?(ПараметрыОперации.Свойство("ДокументСсылка"), ПараметрыОперации.ДокументСсылка, Неопределено); 
			ФискальныйПризнак = ?(ПараметрыОперации.Свойство("ФискальныйПризнак"), ПараметрыОперации.ФискальныйПризнак, Неопределено); 
			
			Если НЕ ЗначениеЗаполнено(ДокументСсылка) И ПустаяСтрока(ФискальныйПризнак) Тогда
				ТекстОшибки = НСтр("ru = 'Не указаны параметры печати копии документа.'");
				ДанныеОперации.Результат = Ложь;
				ДанныеОперации.ТекстОшибки = ТекстОшибки;
				Возврат ДанныеОперации;
			КонецЕсли;
				
			ФискальнаяОперация = ДанныеФискальнойОперации(ДокументСсылка, Неопределено, Неопределено, Неопределено, ФискальныйПризнак);
			Если ФискальнаяОперация = Неопределено Тогда
				ТекстОшибки = НСтр("ru = 'Фискальный документ для печати копии не найден.'");
				ДанныеОперации.Результат = Ложь;
				ДанныеОперации.ТекстОшибки = ТекстОшибки;
				Возврат ДанныеОперации;
			КонецЕсли;
			
			ПараметрыQRКода = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыQRКодаЧекаККТ();
			ПараметрыQRКода.ДатаВремяРасчета  = ФискальнаяОперация.Дата;
			ПараметрыQRКода.СуммаРасчета      = ФискальнаяОперация.Сумма;
			ПараметрыQRКода.ФискальныйПризнак = ФискальнаяОперация.ФискальныйПризнак;
			ПараметрыQRКода.ПризнакРасчета    = ФискальнаяОперация.ТипРасчета;
			ПараметрыQRКода.НомерФискальногоНакопителя = ФискальнаяОперация.ЗаводскойНомерФН;
			ПараметрыQRКода.НомерФискальногоДокумента  = ФискальнаяОперация.НомерЧекаККМ;
			QRКодЧекаККТ = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.СформироватьQRКодЧекаККТ(ПараметрыQRКода);
			
			ДанныеXML = ФискальнаяОперация.ДанныеXML.Получить();    
			ПараметрыКопииЧека = ЗагрузитьДанныеФискализацииИзXML(ДанныеXML);           
			ПараметрыКопииЧека.ДатаВремя = ФискальнаяОперация.Дата; 
			
			ПараметрыПечати  = ШаблоныФискальныхДокументов.ПараметрыШаблонаФискальногоДокумента();
			ПараметрыПечати.Заголовок = НСтр("ru = 'КОПИЯ ЧЕКА'");;
			ПараметрыПечати.ВыводитьФискальнуюИнформацию = Ложь;
			Шаблон    = ШаблоныФискальныхДокументов.ШаблонКассовыйЧек(ПараметрыПодключения.ШиринаСтроки, ПараметрыКопииЧека, ФискальнаяОперация, ПараметрыПечати);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон); 
			
			ТекстЧека = ПараметрыПечати.Заголовок + Символы.ПС + ТекстЧека;
			ТекстЧека = ТекстЧека  + Символы.ПС + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыстроитьПоля(НСтр("ru = 'РН ККТ:'"), ФискальнаяОперация.РегистрационныйНомерККТ, ШиринаСтроки);
			ТекстЧека = ТекстЧека  + Символы.ПС + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыстроитьПоля(НСтр("ru = 'ФН №:'")  , ФискальнаяОперация.ЗаводскойНомерФН, ШиринаСтроки);
			ТекстЧека = ТекстЧека  + Символы.ПС + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыстроитьПоля(НСтр("ru = 'ФД №:'")  , Формат(ФискальнаяОперация.НомерЧекаККМ,"ЧГ="), ШиринаСтроки);
			ТекстЧека = ТекстЧека  + Символы.ПС + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыстроитьПоля(НСтр("ru = 'ФП:'")    , ФискальнаяОперация.ФискальныйПризнак, ШиринаСтроки);
			ТекстЧека = ТекстЧека + Символы.ПС + "|ШтрихКод|QR|" + QRКодЧекаККТ; 
			ДанныеОперации.Вставить("ТестовыеЧеки", ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса));     
			ДанныеОперации.ТекстЧека = ТекстЧека;

			ДанныеОперации.Вставить("ТестовыеЧеки", ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса));   
		КонецЕсли;
		
		ДанныеОперации.Вставить("НомерЧека", ПараметрыОперации.НомерЧека);
		ДанныеОперации.Вставить("Аппаратно", Аппаратно); 
		
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "PrintText" Тогда
		
		ДанныеОперации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ПараметрыОперации.СтрокиТекста, ПараметрыПодключения.РевизияИнтерфейса); 
		ДанныеОперации.ТекстЧека = ПараметрыОперации.СтрокиТекста; 
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "PrintQRCode" Тогда
		
		ТекстЧека = Символы.ПС;
		ТестовыйЧек = Новый Массив();
		Если Не ПустаяСтрока(ПараметрыОперации.QRКод.ЗначениеКода) Тогда
			
			СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека();
			ТестовыйЧек.Добавить(СтрокаЧека);
			
			СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыШтрихкодВСтрокеЧека("QR", ПараметрыОперации.QRКод.ЗначениеКода);
			ТестовыйЧек.Добавить(СтрокаЧека);
			
			СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека();
			ТестовыйЧек.Добавить(СтрокаЧека);
				
			ТекстЧека = ТекстЧека + Символы.ПС + "|ШтрихКод|QR|" + ПараметрыОперации.QRКод.ЗначениеКода + Символы.ПС; 
			ТекстЧека = ТекстЧека + Символы.НПП + Символы.ПС; 
			
			Если Не ПустаяСтрока(ПараметрыОперации.ТипПлатежнойСистемы) Тогда
				СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека(ПараметрыОперации.ТипПлатежнойСистемы);
				СтрокаЧека.Выравнивание = "Центр";
				ТестовыйЧек.Добавить(СтрокаЧека);
				ТекстЧека = ТекстЧека + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыровнятьПоле(ПараметрыОперации.ТипПлатежнойСистемы, ПараметрыПодключения.ШиринаСтроки, "Центр") + Символы.ПС; 
			КонецЕсли;
			
			СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека(ПараметрыОперации.QRКод.ТекстПользователя);
			СтрокаЧека.Выравнивание = "Центр";
			ТестовыйЧек.Добавить(СтрокаЧека);
			
			Если ЗначениеЗаполнено(ПараметрыОперации.СуммаОперации) Тогда
				ФорматЧисла = "ЧРД=.;ЧЦ=12;ЧДЦ=2;ЧН=0.00;ЧГ=0";
				ТекстСуммаОперации = СтрШаблон(НСтр("ru='Сумма операции: %1'"), Формат(ПараметрыОперации.СуммаОперации, ФорматЧисла));
				СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека(ТекстСуммаОперации);
				СтрокаЧека.Выравнивание = "Центр";
				ТестовыйЧек.Добавить(СтрокаЧека);
				ТекстЧека = ТекстЧека + ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ВыровнятьПоле(ТекстСуммаОперации, ПараметрыПодключения.ШиринаСтроки, "Центр") + Символы.ПС; 
				ТекстЧека = ТекстЧека + Символы.НПП + Символы.ПС; 
			КонецЕсли;
			
			СтрокаЧека = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыТекстовойСтрокиЧека();
			ТестовыйЧек.Добавить(СтрокаЧека);
		КонецЕсли;
		
		НефискальныеДокументы = Новый Массив();
		НефискальныеДокументы.Добавить(ТестовыйЧек);
		
		ТестовыеЧеки =  Новый Массив();
		ЗаполнитьXMLПакетыДляТекстовогоДокумента(
			ТестовыеЧеки, НефискальныеДокументы, 
			ПараметрыПодключения, 
			ПараметрыПодключения.ШиринаСтроки);
		ДанныеОперации.Вставить("ТестовыеЧеки", ТестовыеЧеки);
		ДанныеОперации.ТекстЧека = ТекстЧека; 
		
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "OpenShift"  Тогда
		//Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
		//	
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
		//	
		//КонецЕсли;
		
		ДанныеОперации = ПараметрыФискальнойОперации();
		Если ПараметрыОперации.Свойство("ДополнительныеПараметры") Тогда
			ДанныеОперации.ДополнительныеПараметры = ПараметрыОперации.ДополнительныеПараметры;
		КонецЕсли;
		 
		Если Не ПередОткрытиемКассовойСмены(ПараметрыПодключения, ДанныеОперации) Тогда
			Возврат ДанныеОперации;
		КонецЕсли;
			
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			ДанныеОперации.ПараметрыXML = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
		ИначеЕсли ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			Шаблон    = ШаблоныФискальныхДокументов.ШаблонОтчетОбОткрытииСмены(ПараметрыПодключения.ШиринаСтроки, ПараметрыОперации);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон); 
			
			ДанныеОперации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
	                ДанныеОперации.ТекстЧека = ТекстЧека; 
		КонецЕсли;
			
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "CloseShift" Тогда
		//Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
		//	
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
		//	
		//КонецЕсли;
		
		ДанныеОперации = ПараметрыФискальнойОперации();
		Если ПараметрыОперации.Свойство("ДополнительныеПараметры") Тогда
			ДанныеОперации.ДополнительныеПараметры = ПараметрыОперации.ДополнительныеПараметры;
		КонецЕсли;
		
		Если Не ПередЗакрытиемКассовойСмены(ПараметрыПодключения, ДанныеОперации) Тогда
			Возврат ДанныеОперации;
		КонецЕсли;
		
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			ДанныеОперации.ПараметрыXML = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
		ИначеЕсли ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			Шаблон    = ШаблоныФискальныхДокументов.ШаблонОтчетОЗакрытииСмены(ПараметрыПодключения.ШиринаСтроки, ПараметрыОперации);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон); 
			
			ДанныеОперации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
			ДанныеОперации.ТекстЧека = ТекстЧека; 
		КонецЕсли;
		
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "ReportCurrentStatusOfSettlements" Или Команда = "GetCurrentStatus"  Тогда
		
		Если ПараметрыОперации = Неопределено Тогда
			ПараметрыОперации = Новый Структура();
		КонецЕсли;
		
		ДанныеОперации = ПараметрыФискальнойОперации();
		ДанныеОперации.ПараметрыXML = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "PrintXReport"  Тогда
		//Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
		//	
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
		//	
		//КонецЕсли;
		
		Если ПараметрыОперации = Неопределено Тогда
			ПараметрыОперации = Новый Структура();
		КонецЕсли;
		
		ДанныеОперации = ПараметрыФискальнойОперации();
		
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			
			ДанныеОперации.ПараметрыXML = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
			
		ИначеЕсли ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			Шаблон    = ШаблоныФискальныхДокументов.ШаблонОтчетОТекущемСостоянии(ПараметрыПодключения.ШиринаСтроки, ПараметрыОперации);
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон); 

			ДанныеОперации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
	                ДанныеОперации.ТекстЧека = ТекстЧека; 
		КонецЕсли;
		
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "Encash" Тогда
		//Для печати на принтерах чеков
		//Если ПараметрыПодключения.ТипыОборудования.ПринтерЧеков И ПараметрыОперации.Свойство("АвтономнаяККТ") И НЕ ПараметрыОперации.АвтономнаяККТ Тогда
		//	
		//	ОписаниеОшибки = НСтр("ru='Фискализация на принтерах чеков запрещена.'");
		//	ДанныеОперации.Результат = Ложь;
		//	ДанныеОперации.ТекстОшибки = ОписаниеОшибки;
		//	Возврат ДанныеОперации;
		//	
		//КонецЕсли;
		
		ПараметрыФискализации = ПараметрыФискализацииЧека();
		Если ПараметрыОперации.ТипИнкассации = 0 Тогда
			ПараметрыФискализации.ТипДокумента = Перечисления.ТипыФискальныхДокументовККТ.Выемка
		Иначе
			ПараметрыФискализации.ТипДокумента = Перечисления.ТипыФискальныхДокументовККТ.Внесение
		КонецЕсли;
		ПараметрыФискализации.ТипИнкассации = ПараметрыОперации.ТипИнкассации; 
		ПараметрыФискализации.ДатаВремяЧека = ОбщегоНазначенияБПО.ДатаСеанса();
		
		Если ПараметрыПодключения.ТипыОборудования.ККТ Тогда
			
			ПараметрыРегистрации = ПараметрыРегистрацииУстройства(ПараметрыПодключения.ИдентификаторУстройства);
			
			ПараметрыФискализации.РегистрационныйНомерККТ = ?(ПараметрыРегистрации.Свойство("РегистрационныйНомерККТ"), ПараметрыРегистрации.РегистрационныйНомерККТ, "");
			ПараметрыФискализации.ЗаводскойНомерФН  = ?(ПараметрыРегистрации.Свойство("ЗаводскойНомерФН"), ПараметрыРегистрации.ЗаводскойНомерФН, "");
			ПараметрыФискализации.ШиринаСтроки      = ?(ПараметрыПодключения.Свойство("ШиринаСтроки"), ПараметрыПодключения.ШиринаСтроки, 32);
			ПараметрыФискализации.РевизияИнтерфейса = ПараметрыПодключения.РевизияИнтерфейса;
			
			Если ПараметрыОперации.Свойство("ДокументОснование") Тогда 
				ПараметрыФискализации.ДокументОснование = ПараметрыОперации.ДокументОснование;
			КонецЕсли;
			Если ПараметрыОперации.Свойство("Кассир") Тогда
				ПараметрыФискализации.Кассир = ПараметрыОперации.Кассир;
			КонецЕсли;
			Если ПараметрыОперации.Свойство("Организация") Тогда
				ПараметрыФискализации.Организация = ПараметрыОперации.Организация;
			КонецЕсли;
			Если ПараметрыОперации.Свойство("ТорговыйОбъект") Тогда
				ПараметрыФискализации.ТорговыйОбъект = ПараметрыОперации.ТорговыйОбъект;
			КонецЕсли;
			ПараметрыФискализации.СуммаЧека      = ПараметрыОперации.Сумма;
			ПараметрыФискализации.ОплатаНаличные = ПараметрыОперации.Сумма;
			ПараметрыФискализации.ДанныеЧекаXML  = ПолучитьXMLПакетДляОперации(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса);
			
		ИначеЕсли ПараметрыПодключения.ТипыОборудования.ПринтерЧеков Тогда
			
			Если ПараметрыОперации.ТипИнкассации = 1 Тогда
				Шаблон = ШаблоныФискальныхДокументов.ШаблонВнесениеНаличных(ПараметрыПодключения.ШиринаСтроки, ПараметрыОперации);
			Иначе
				Шаблон = ШаблоныФискальныхДокументов.ШаблонСнятиеНаличных(ПараметрыПодключения.ШиринаСтроки, ПараметрыОперации);
			КонецЕсли;
			ТекстЧека = ШаблоныФискальныхДокументов.ВывестиКакТекст(Шаблон); 
			
			ПараметрыФискализации.ТестовыеЧеки = ПолучитьXMLПакетДляТекста(ТекстЧека, ПараметрыПодключения.РевизияИнтерфейса);
	                ПараметрыФискализации.ТекстЧека = ТекстЧека; 
			
		КонецЕсли;
		
		Возврат ПараметрыФискализации;
		
	ИначеЕсли Команда = "OperationFN" Тогда
		
		ДанныеОперации = ПараметрыФискальнойОперации();
		ДанныеОперации.Вставить("ТипОперации", ПараметрыОперации.ТипОперации);
		РевизияИнтерфейса  = ПараметрыПодключения.РевизияИнтерфейса;
		ДанныеОперации.ПараметрыXML = СформироватьТаблицуПараметровДляОперацииФН(ПараметрыОперации, РевизияИнтерфейса);
		Возврат ДанныеОперации;
		
	ИначеЕсли Команда = "RequestKM" Или Команда = "RequestKMKMNoWait" Тогда
		
		// ++ Локализация
		Если Команда = "RequestKMKMNoWait" Тогда
			ПараметрыОперации.ОжидатьПолучениеОтветаОИСМ = Ложь;
		КонецЕсли;                              
		
		ДанныеОперации = ОборудованиеЧекопечатающиеУстройстваКлиентСервер.ПараметрыЗапросКМ();
		Если ОбщегоНазначенияБПО.ИспользуетсяМаркировка() Тогда
			Если ПустаяСтрока(ПараметрыОперации.ИдентификаторЗапроса) Тогда
				ПараметрыОперации.ИдентификаторЗапроса = Новый УникальныйИдентификатор;
			КонецЕсли;
			
			Если Не ПустаяСтрока(ПараметрыОперации.КонтрольнаяМарка) Тогда
			ДанныеОперации.Вставить("Результат", Истина);
			ДанныеОперации.Вставить("ТекстОшибки");
			МодульМенеджерОборудованияМаркировка = ОбщегоНазначенияБПО.ОбщийМодуль("МенеджерОборудованияМаркировка");
			ДанныеОперации.Вставить("ПараметрыXML", 
				МодульМенеджерОборудованияМаркировка.СформироватьXMLДляЗапросаКМ(ПараметрыОперации, ПараметрыПодключения.РевизияИнтерфейса));
			ЗаполнитьЗначенияСвойств(ДанныеОперации, ПараметрыОперации);
			Иначе
				ТекстОшибки = НСтр("ru = 'Контрольная марка не может быть пустой.'");
				ДанныеОперации.Вставить("Результат", Ложь);
				ДанныеОперации.Вставить("ТекстОшибки", ТекстОшибки);
			КонецЕсли;
		КонецЕсли;
		
		Возврат ДанныеОперации;
		// -- Локализация
		
	ИначеЕсли Команда = "CheckKM" Тогда
		
		// ++ Локализация
		ДанныеОперации = ОбщегоНазначенияБПО.СкопироватьРекурсивно(ПараметрыОперации);
		ДанныеОперации.Вставить("Результат", Истина);
		ДанныеОперации.Вставить("ТекстОшибки", "");
		Если ОбщегоНазначенияБПО.ИспользуетсяМаркировка() Тогда
			МодульМенеджерОборудованияМаркировка = ОбщегоНазначенияБПО.ОбщийМодуль("МенеджерОборудованияМаркировка");
			
			Для Каждого Операция Из ДанныеОперации.ЗапросыКМ Цикл
				
				Если ПустаяСтрока(Операция.ИдентификаторЗапроса) Тогда
					Операция.ИдентификаторЗапроса = Строка(Новый УникальныйИдентификатор);
				КонецЕсли;
				
				Операция.ОтправлятьНаСерверОИСМ     = Операция.ЗапросПроверкиКМСредствамиККТ;
				Операция.Вставить("ПараметрыXML", 
					МодульМенеджерОборудованияМаркировка.СформироватьXMLДляЗапросаКМ(Операция, ПараметрыПодключения.РевизияИнтерфейса));
				
			КонецЦикла;
		КонецЕсли;
		
		Возврат ДанныеОперации;
		// -- Локализация
		
	ИначеЕсли Команда = "CheckFiscalizationPacket" Тогда
		
		ДанныеОперации = ПараметрыФискализацииЧека();       
		
		Если ПараметрыОперации <> Неопределено И ПараметрыОперации.Свойство("ДанныеЧекаXML") Тогда
			ДанныеОперации.ДанныеЧекаXML = ПараметрыОперации.ДанныеЧекаXML;
		КонецЕсли;
		
		Возврат ДанныеОперации;
		
	КонецЕсли
	
КонецФункции
